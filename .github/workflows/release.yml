# Release workflow — builds the Hew compiler for multiple platforms and creates
# a GitHub Release with signed/notarized binaries and checksums.
#
# Triggers on tag push matching `v*` (e.g. v0.1.0).
#
# Artifacts per platform:
#   bin/hew           — compiler driver
#   bin/adze          — package manager
#   bin/hew-codegen   — C++ MLIR compiler (statically linked)
#   bin/hew-lsp       — Language Server Protocol server
#   lib/libhew_runtime.a — Rust actor runtime static library
#   std/              — standard library sources
#   completions/      — shell completions (bash, zsh, fish)
#
# Required secrets for macOS code signing (optional — skipped if absent):
#   APPLE_CERTIFICATE_P12       — Base64-encoded .p12 signing certificate
#   APPLE_CERTIFICATE_PASSWORD  — Password for the .p12 file
#   APPLE_API_KEY_P8            — App Store Connect API private key (.p8 contents)
#   APPLE_API_KEY_ID            — App Store Connect API key ID
#   APPLE_API_ISSUER_ID         — App Store Connect API issuer ID
#
# Required secrets for Homebrew tap updates (optional — skipped if absent):
#   HOMEBREW_TAP_TOKEN           — GitHub PAT with actions:write scope for hew-lang/homebrew-hew
#
# Required secrets for VS Code extension publishing (optional — skipped if absent):
#   VSCE_PAT                     — VS Code Marketplace Personal Access Token

name: Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag to release (e.g. v0.1.0)"
        required: true
        type: string

permissions:
  contents: write
  packages: write

env:
  LLVM_VERSION: "21"
  # Resolve tag from push event or manual dispatch input
  RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Build — one job per platform target
  # ─────────────────────────────────────────────────────────────────────────
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: linux-x86_64
            os: ubuntu-24.04
            rust_target: x86_64-unknown-linux-gnu
          - target: linux-aarch64
            os: ubuntu-24.04-arm
            rust_target: aarch64-unknown-linux-gnu
          - target: darwin-x86_64
            os: macos-15
            rust_target: x86_64-apple-darwin
          - target: darwin-aarch64
            os: macos-14
            rust_target: aarch64-apple-darwin
          - target: windows-x86_64
            os: windows-2022
            rust_target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.os }}
    # Windows and macOS x86_64 MLIR builds can be flaky — don't block the release
    continue-on-error: ${{ startsWith(matrix.target, 'windows') || matrix.target == 'darwin-x86_64' }}
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      # ── LLVM/MLIR installation ──────────────────────────────────────────

      - name: Install LLVM/MLIR (Linux)
        if: startsWith(matrix.target, 'linux')
        run: |
          sudo mkdir -p /etc/apt/keyrings
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key \
            | sudo tee /etc/apt/keyrings/llvm.asc >/dev/null
          echo "deb [signed-by=/etc/apt/keyrings/llvm.asc] http://apt.llvm.org/noble/ llvm-toolchain-noble-${{ env.LLVM_VERSION }} main" \
            | sudo tee /etc/apt/sources.list.d/llvm.list >/dev/null
          sudo apt-get update
          sudo apt-get install -y \
            cmake ninja-build \
            llvm-${{ env.LLVM_VERSION }}-dev \
            libmlir-${{ env.LLVM_VERSION }}-dev \
            mlir-${{ env.LLVM_VERSION }}-tools \
            clang-${{ env.LLVM_VERSION }} \
            libssl-dev pkg-config

      - name: Install LLVM/MLIR (macOS)
        if: startsWith(matrix.target, 'darwin')
        run: |
          brew install llvm@${{ env.LLVM_VERSION }} ninja
          # Expose the brew LLVM prefix for later steps
          LLVM_PREFIX="$(brew --prefix llvm@${{ env.LLVM_VERSION }})"
          echo "LLVM_PREFIX=${LLVM_PREFIX}" >> "$GITHUB_ENV"

      - name: Install LLVM/MLIR (Windows)
        if: startsWith(matrix.target, 'windows')
        run: |
          choco install ninja cmake -y
          choco install llvm --version=${{ env.LLVM_VERSION }}.1.0 -y
        shell: pwsh

      # ── Rust toolchain ──────────────────────────────────────────────────

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Cache Rust artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: release-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            release-${{ matrix.target }}-cargo-

      # ── Rust builds ─────────────────────────────────────────────────────

      - name: Build hew-runtime
        run: cargo build -p hew-runtime --release --target ${{ matrix.rust_target }}

      - name: Build hew, adze, and hew-lsp
        run: cargo build -p hew-cli -p adze-cli -p hew-lsp --release --target ${{ matrix.rust_target }}

      - name: Smoke test hew-lsp (Unix)
        if: "!startsWith(matrix.target, 'windows')"
        run: |
          ./target/${{ matrix.rust_target }}/release/hew-lsp --version

      - name: Smoke test hew-lsp (Windows)
        if: startsWith(matrix.target, 'windows')
        run: ./target/${{ matrix.rust_target }}/release/hew-lsp.exe --version

      # ── hew-codegen (CMake + MLIR) ───────────────────────────────────────────

      - name: Configure hew-codegen (Linux)
        if: startsWith(matrix.target, 'linux')
        run: |
          cd hew-codegen
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=clang-${{ env.LLVM_VERSION }} \
            -DCMAKE_CXX_COMPILER=clang++-${{ env.LLVM_VERSION }} \
            -DHEW_STATIC_LINK=ON \
            -DLLVM_DIR=/usr/lib/llvm-${{ env.LLVM_VERSION }}/lib/cmake/llvm \
            -DMLIR_DIR=/usr/lib/llvm-${{ env.LLVM_VERSION }}/lib/cmake/mlir

      - name: Configure hew-codegen (macOS)
        if: startsWith(matrix.target, 'darwin')
        run: |
          cd hew-codegen
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER="${LLVM_PREFIX}/bin/clang" \
            -DCMAKE_CXX_COMPILER="${LLVM_PREFIX}/bin/clang++" \
            -DCMAKE_OSX_SYSROOT="$(xcrun --show-sdk-path)" \
            -DCMAKE_EXE_LINKER_FLAGS="-L${LLVM_PREFIX}/lib/c++ -Wl,-rpath,${LLVM_PREFIX}/lib/c++" \
            -DHEW_STATIC_LINK=ON \
            -DLLVM_DIR="${LLVM_PREFIX}/lib/cmake/llvm" \
            -DMLIR_DIR="${LLVM_PREFIX}/lib/cmake/mlir"

      - name: Configure hew-codegen (Windows)
        if: startsWith(matrix.target, 'windows')
        run: |
          cd hew-codegen
          cmake -B build -G Ninja `
            -DCMAKE_BUILD_TYPE=Release `
            -DHEW_STATIC_LINK=ON `
            -DLLVM_DIR="C:/Program Files/LLVM/lib/cmake/llvm" `
            -DMLIR_DIR="C:/Program Files/LLVM/lib/cmake/mlir"
        shell: pwsh

      - name: Build hew-codegen
        run: cmake --build hew-codegen/build --config Release

      # ── Package archive ─────────────────────────────────────────────────

      - name: Package archive (Unix)
        if: "!startsWith(matrix.target, 'windows')"
        run: |
          VERSION="${RELEASE_TAG#v}"
          ARCHIVE_NAME="hew-v${VERSION}-${{ matrix.target }}"

          mkdir -p "${ARCHIVE_NAME}/bin" "${ARCHIVE_NAME}/lib" \
                   "${ARCHIVE_NAME}/std" "${ARCHIVE_NAME}/completions"

          # Binaries
          cp "target/${{ matrix.rust_target }}/release/hew"           "${ARCHIVE_NAME}/bin/"
          cp "target/${{ matrix.rust_target }}/release/adze"          "${ARCHIVE_NAME}/bin/"
          cp "hew-codegen/build/src/hew-codegen"                            "${ARCHIVE_NAME}/bin/"
          cp "target/${{ matrix.rust_target }}/release/hew-lsp"          "${ARCHIVE_NAME}/bin/"
          chmod +x "${ARCHIVE_NAME}/bin/"*

          # Runtime library
          cp "target/${{ matrix.rust_target }}/release/libhew_runtime.a" "${ARCHIVE_NAME}/lib/"

          # Standard library sources
          cp std/*.hew "${ARCHIVE_NAME}/std/" 2>/dev/null || true

          # Shell completions (hew + adze)
          cp completions/hew.bash completions/hew.zsh completions/hew.fish \
             completions/adze.bash completions/adze.zsh completions/adze.fish \
             "${ARCHIVE_NAME}/completions/" 2>/dev/null || true

          # Licenses and docs
          cp LICENSE-MIT LICENSE-APACHE NOTICE README.md "${ARCHIVE_NAME}/"

          # Strip binaries
          for b in hew adze hew-codegen hew-lsp; do
            strip "${ARCHIVE_NAME}/bin/${b}" 2>/dev/null || true
          done

          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> "$GITHUB_ENV"

      - name: Package archive (Windows)
        if: startsWith(matrix.target, 'windows')
        run: |
          $Version = "${{ github.ref_name }}".TrimStart("v")
          $ArchiveName = "hew-v${Version}-${{ matrix.target }}"

          New-Item -ItemType Directory -Path "${ArchiveName}/bin", "${ArchiveName}/lib", "${ArchiveName}/std" -Force | Out-Null

          Copy-Item "target/${{ matrix.rust_target }}/release/hew.exe"          "${ArchiveName}/bin/"
          Copy-Item "target/${{ matrix.rust_target }}/release/adze.exe"         "${ArchiveName}/bin/"
          Copy-Item "hew-codegen/build/src/hew-codegen.exe"                           "${ArchiveName}/bin/"
          Copy-Item "target/${{ matrix.rust_target }}/release/hew-lsp.exe"            "${ArchiveName}/bin/"
          Copy-Item "target/${{ matrix.rust_target }}/release/hew_runtime.lib"  "${ArchiveName}/lib/"

          # Standard library sources
          Copy-Item "std/*.hew" "${ArchiveName}/std/" -ErrorAction SilentlyContinue

          # Licenses
          Copy-Item "LICENSE-MIT" "${ArchiveName}/"
          Copy-Item "LICENSE-APACHE" "${ArchiveName}/"
          Copy-Item "NOTICE" "${ArchiveName}/"
          Copy-Item "README.md" "${ArchiveName}/"

          echo "ARCHIVE_NAME=${ArchiveName}" >> $env:GITHUB_ENV
        shell: pwsh

      # ── macOS code signing & notarization ───────────────────────────────

      - name: Code sign binaries (macOS)
        if: startsWith(matrix.target, 'darwin') && env.APPLE_CERTIFICATE_P12 != ''
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Import signing certificate into a temporary keychain
          echo "${APPLE_CERTIFICATE_P12}" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain \
            -P "${APPLE_CERTIFICATE_PASSWORD}" -T /usr/bin/codesign
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: -s -k "" build.keychain

          # Find the Developer ID Application identity from the imported cert
          IDENTITY=$(security find-identity -v -p codesigning build.keychain \
            | grep "Developer ID Application" \
            | head -1 \
            | sed 's/.*"\(.*\)".*/\1/')

          if [ -z "${IDENTITY}" ]; then
            echo "::error::No Developer ID Application certificate found in keychain"
            exit 1
          fi
          echo "Signing with identity: ${IDENTITY}"

          # Sign each binary with hardened runtime and secure timestamp
          for bin in hew adze hew-codegen hew-lsp; do
            codesign --force --options runtime --timestamp \
              --sign "${IDENTITY}" "${ARCHIVE_NAME}/bin/${bin}"
          done

          # Verify signatures
          for bin in hew adze hew-codegen hew-lsp; do
            codesign --verify --verbose "${ARCHIVE_NAME}/bin/${bin}"
          done

          rm -f certificate.p12

      - name: Notarize archive (macOS)
        if: startsWith(matrix.target, 'darwin') && env.APPLE_CERTIFICATE_P12 != '' && env.APPLE_API_KEY_P8 != ''
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_API_KEY_P8: ${{ secrets.APPLE_API_KEY_P8 }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: |
          # Write the API key (base64-encoded in secret) to disk
          mkdir -p ~/private_keys
          echo "${APPLE_API_KEY_P8}" | base64 --decode > ~/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8

          ditto -c -k --keepParent "${ARCHIVE_NAME}" "${ARCHIVE_NAME}-notarize.zip"
          xcrun notarytool submit "${ARCHIVE_NAME}-notarize.zip" \
            --key ~/private_keys/AuthKey_${APPLE_API_KEY_ID}.p8 \
            --key-id "${APPLE_API_KEY_ID}" \
            --issuer "${APPLE_API_ISSUER_ID}" \
            --wait
          rm -f "${ARCHIVE_NAME}-notarize.zip"
          rm -rf ~/private_keys

      # ── Create final archive ────────────────────────────────────────────

      - name: Create tar.gz (Unix)
        if: "!startsWith(matrix.target, 'windows')"
        run: tar czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"

      - name: Create zip (Windows)
        if: startsWith(matrix.target, 'windows')
        run: Compress-Archive -Path "${env:ARCHIVE_NAME}" -DestinationPath "${env:ARCHIVE_NAME}.zip"
        shell: pwsh

      # ── Upload artifact ─────────────────────────────────────────────────

      - name: Upload artifact (Unix)
        if: "!startsWith(matrix.target, 'windows')"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: ${{ env.ARCHIVE_NAME }}.tar.gz

      - name: Upload artifact (Windows)
        if: startsWith(matrix.target, 'windows')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: ${{ env.ARCHIVE_NAME }}.zip

      - name: Upload hew-lsp standalone (Unix)
        if: "!startsWith(matrix.target, 'windows')"
        uses: actions/upload-artifact@v4
        with:
          name: hew-lsp-${{ matrix.target }}
          path: target/${{ matrix.rust_target }}/release/hew-lsp

      - name: Upload hew-lsp standalone (Windows)
        if: startsWith(matrix.target, 'windows')
        uses: actions/upload-artifact@v4
        with:
          name: hew-lsp-${{ matrix.target }}
          path: target/${{ matrix.rust_target }}/release/hew-lsp.exe

  # ─────────────────────────────────────────────────────────────────────────
  # Linux packages — build .deb, .rpm, .pkg.tar.zst, .apk from tarballs
  # ─────────────────────────────────────────────────────────────────────────
  linux-packages:
    needs: build
    if: ${{ !cancelled() && needs.build.result != 'failure' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            os: ubuntu-24.04
            artifact_pattern: "hew-v*-linux-x86_64"
          - arch: aarch64
            os: ubuntu-24.04-arm
            artifact_pattern: "hew-v*-linux-aarch64"
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Download Linux tarball
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ matrix.artifact_pattern }}
          path: dist/
          merge-multiple: true

      - name: Build Linux packages
        run: |
          VERSION="${RELEASE_TAG#v}"
          installers/build-packages.sh \
            --version "${VERSION}" \
            --arch "${{ matrix.arch }}" \
            --skip-build \
            --only debian,rpm,arch,alpine

      - name: Upload Linux packages
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages-${{ matrix.arch }}
          path: |
            dist/*.deb
            dist/*.rpm
            dist/*.pkg.tar.zst
            dist/*.apk

  # ─────────────────────────────────────────────────────────────────────────
  # Release — download all artifacts, generate checksums, publish
  # ─────────────────────────────────────────────────────────────────────────
  release:
    needs: [build, linux-packages]
    runs-on: ubuntu-24.04
    # Run as long as build didn't hard-fail — linux-packages and continue-on-error
    # targets (Windows, macOS x86_64) are allowed to fail without blocking release
    if: ${{ !cancelled() && needs.build.result != 'failure' }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "hew-v*"
          path: artifacts
          merge-multiple: true

      - name: Download linux package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "linux-packages-*"
          path: artifacts
          merge-multiple: true
        continue-on-error: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum \
            hew-v*-*.tar.gz hew-v*-*.zip \
            hew_*.deb hew-*.rpm hew-bin-*.pkg.tar.zst hew-*.apk \
            2>/dev/null | tee checksums.txt
          VERSION="${RELEASE_TAG#v}"
          mv checksums.txt "hew-v${VERSION}-checksums.txt"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          generate_release_notes: true
          files: |
            artifacts/hew-v*-*.tar.gz
            artifacts/hew-v*-*.zip
            artifacts/hew_*.deb
            artifacts/hew-*.rpm
            artifacts/hew-bin-*.pkg.tar.zst
            artifacts/hew-*.apk
            artifacts/hew-v*-checksums.txt

  # ─────────────────────────────────────────────────────────────────────────
  # Docker — multi-arch image pushed to ghcr.io/hew-lang/hew
  # ─────────────────────────────────────────────────────────────────────────
  docker:
    needs: build
    runs-on: ubuntu-24.04
    if: ${{ !cancelled() && needs.build.result != 'failure' }}
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Download Linux tarballs
        uses: actions/download-artifact@v4
        with:
          pattern: "hew-v*-linux-*"
          path: docker-ctx/
          merge-multiple: true

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: echo "version=${RELEASE_TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v6
        with:
          context: docker-ctx/
          file: installers/docker/Dockerfile.release
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/hew-lang/hew:${{ steps.version.outputs.version }}
            ghcr.io/hew-lang/hew:latest

  # ─────────────────────────────────────────────────────────────────────────
  # Homebrew — trigger formula update in hew-lang/homebrew-hew
  # ─────────────────────────────────────────────────────────────────────────
  homebrew:
    needs: release
    runs-on: ubuntu-24.04
    if: ${{ !cancelled() && needs.release.result == 'success' }}
    timeout-minutes: 5

    steps:
      - name: Trigger homebrew-hew formula update
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${RELEASE_TAG#v}"
          gh workflow run update-formula.yml \
            -R hew-lang/homebrew-hew \
            -f version="${VERSION}"

  # ─────────────────────────────────────────────────────────────────────────
  # Playground — trigger Docker image rebuild in hew-lang/playground
  # ─────────────────────────────────────────────────────────────────────────
  playground:
    needs: release
    runs-on: ubuntu-24.04
    if: ${{ !cancelled() && needs.release.result == 'success' }}
    timeout-minutes: 5

    steps:
      - name: Trigger playground image rebuild
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${RELEASE_TAG#v}"
          gh workflow run build.yml \
            -R hew-lang/playground \
            -f version="${VERSION}"

  # ─────────────────────────────────────────────────────────────────────────
  # VS Code Extension — package + publish with bundled hew-lsp per platform
  # ─────────────────────────────────────────────────────────────────────────
  vscode-extension:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ !cancelled() && needs.build.result != 'failure' }}
    timeout-minutes: 15

    # Map hew release targets to VS Code platform identifiers
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: linux-x86_64
            vscode_target: linux-x64
            binary: hew-lsp
          - target: linux-aarch64
            vscode_target: linux-arm64
            binary: hew-lsp
          - target: darwin-x86_64
            vscode_target: darwin-x64
            binary: hew-lsp
          - target: darwin-aarch64
            vscode_target: darwin-arm64
            binary: hew-lsp
          - target: windows-x86_64
            vscode_target: win32-x64
            binary: hew-lsp.exe

    steps:
      - name: Download hew-lsp binary
        uses: actions/download-artifact@v4
        with:
          name: hew-lsp-${{ matrix.target }}
          path: lsp-binary/
        continue-on-error: true
        id: download

      - name: Clone vscode-hew
        if: steps.download.outcome == 'success'
        run: |
          git clone --depth 1 https://github.com/hew-lang/vscode-hew.git extension
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        if: steps.download.outcome == 'success'
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: extension/package-lock.json

      - name: Install dependencies
        if: steps.download.outcome == 'success'
        run: cd extension && npm ci

      - name: Bundle LSP binary
        if: steps.download.outcome == 'success'
        run: |
          mkdir -p extension/server
          cp "lsp-binary/${{ matrix.binary }}" "extension/server/${{ matrix.binary }}"
          chmod +x "extension/server/${{ matrix.binary }}" 2>/dev/null || true

      - name: Package extension
        if: steps.download.outcome == 'success'
        run: |
          cd extension
          npx vsce package --target ${{ matrix.vscode_target }}

      - name: Upload .vsix artifact
        if: steps.download.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: vsix-${{ matrix.vscode_target }}
          path: extension/*.vsix

  # Publish all platform-specific .vsix packages in a single job
  vscode-publish:
    needs: vscode-extension
    runs-on: ubuntu-latest
    if: ${{ !cancelled() && needs.vscode-extension.result != 'failure' }}
    timeout-minutes: 10

    steps:
      - name: Download all .vsix packages
        uses: actions/download-artifact@v4
        with:
          pattern: "vsix-*"
          path: vsix/
          merge-multiple: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          shopt -s nullglob
          vsix_files=(vsix/*.vsix)
          if [ ${#vsix_files[@]} -eq 0 ]; then
            echo "::warning::No .vsix files found — skipping marketplace publish"
            exit 0
          fi
          if [ -z "${VSCE_PAT}" ]; then
            echo "::warning::VSCE_PAT secret not set — skipping marketplace publish"
            echo "Built .vsix files:"
            ls -lh "${vsix_files[@]}"
            exit 0
          fi
          vsce publish --packagePath "${vsix_files[@]}"
