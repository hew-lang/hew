import std::stream;
import std::fs;
import std::os;

actor FileServer {
    receive fn serve(path: string, sink: Sink) {
        let raw = match stream.from_file(path) {
            Ok(s) => s,
            Err(e) => { panic(e); },
        };
        let lines = raw.lines();
        for await line in lines {
            sink.write(line);
        }
        sink.close();
    }
}

fn main() {
    let tmp = os.temp_dir();
    let path = tmp + "/hew_serve_test.txt";
    unsafe { hew_file_write(path, "alpha\nbeta\ngamma\n"); }

    let (sink, input) = stream.channel(8);

    let server = spawn FileServer;
    server.serve(path, sink);

    for await line in input {
        println(line);
    }
    input.close();
}
