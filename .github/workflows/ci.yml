name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  security-events: write

env:
  LLVM_VERSION: "21"
  CARGO_TERM_COLOR: always

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Path change detection — skip heavy jobs for doc-only changes
  # ─────────────────────────────────────────────────────────────────────────
  changes:
    name: Detect changes
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - '**/*.rs'
              - '**/*.cpp'
              - '**/*.h'
              - '**/*.td'
              - '**/Cargo.toml'
              - '**/Cargo.lock'
              - '**/CMakeLists.txt'
              - 'hew-codegen/**'
              - 'std/**'
              - 'examples/**'
              - 'Makefile'
              - '.github/workflows/ci.yml'

  # ─────────────────────────────────────────────────────────────────────────
  # Lint — fast feedback on code quality (always runs, ~1.5 min)
  # Produces SARIF output for GitHub Code Scanning inline annotations.
  # ─────────────────────────────────────────────────────────────────────────
  lint:
    name: Clippy & format
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git/
            target/
          key: lint-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: lint-${{ runner.os }}-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Install SARIF tools
        run: |
          gh release download clippy-sarif-latest --repo psastras/sarif-rs \
            --pattern "clippy-sarif-x86_64-unknown-linux-gnu" --output clippy-sarif --clobber
          gh release download sarif-fmt-latest --repo psastras/sarif-rs \
            --pattern "sarif-fmt-x86_64-unknown-linux-gnu" --output sarif-fmt --clobber
          chmod +x clippy-sarif sarif-fmt
          mv clippy-sarif sarif-fmt /usr/local/bin/
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Clippy
        run: >
          cargo clippy --workspace --tests --message-format=json
          | clippy-sarif
          | tee clippy-results.sarif
          | sarif-fmt
        continue-on-error: true

      - name: Upload Clippy SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: clippy-results.sarif
          category: clippy
          wait-for-processing: true

  # ─────────────────────────────────────────────────────────────────────────
  # Build & test — Rust workspace tests + hew-codegen E2E (single LLVM install)
  # Produces JUnit XML for GitHub Actions test reporting.
  # ─────────────────────────────────────────────────────────────────────────
  build-and-test:
    name: Build & test (Rust + codegen E2E)
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Install LLVM ${{ env.LLVM_VERSION }} + MLIR
        run: |
          sudo mkdir -p /etc/apt/keyrings
          wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key \
            | sudo tee /etc/apt/keyrings/llvm.asc >/dev/null
          echo "deb [signed-by=/etc/apt/keyrings/llvm.asc] http://apt.llvm.org/noble/ llvm-toolchain-noble-${{ env.LLVM_VERSION }} main" \
            | sudo tee /etc/apt/sources.list.d/llvm.list >/dev/null
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            cmake ninja-build \
            llvm-${{ env.LLVM_VERSION }}-dev \
            libmlir-${{ env.LLVM_VERSION }}-dev \
            mlir-${{ env.LLVM_VERSION }}-tools \
            clang-${{ env.LLVM_VERSION }} \
            lld-${{ env.LLVM_VERSION }} \
            libssl-dev pkg-config

      - uses: dtolnay/rust-toolchain@stable

      - uses: taiki-e/install-action@nextest

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git/
            target/
          key: build-test-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: build-test-${{ runner.os }}-

      - name: Cache hew-codegen build
        uses: actions/cache@v4
        with:
          path: hew-codegen/build
          key: hew-codegen-build-${{ runner.os }}-${{ hashFiles('hew-codegen/**/*.cpp', 'hew-codegen/**/*.h', 'hew-codegen/**/CMakeLists.txt', 'hew-codegen/**/*.td') }}
          restore-keys: hew-codegen-build-${{ runner.os }}-

      - name: Build Rust runtime and frontend (release)
        run: cargo build -p hew-cli -p hew-runtime -p hew-serialize -p hew-lsp --release

      - name: Smoke test hew-lsp
        run: ./target/release/hew-lsp --version

      - name: Build hew binary (debug — needed by test_runner tests)
        run: cargo build -p hew-cli

      - name: Build WASM runtime
        run: |
          rustup target add wasm32-wasip1
          cargo build -p hew-runtime --target wasm32-wasip1 --no-default-features --release

      - name: Install wasmtime
        run: |
          curl https://wasmtime.dev/install.sh -sSf | bash
          echo "$HOME/.wasmtime/bin" >> "$GITHUB_PATH"

      - name: Configure hew-codegen
        run: |
          cd hew-codegen
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_DIR=/usr/lib/llvm-${{ env.LLVM_VERSION }}/lib/cmake/llvm \
            -DMLIR_DIR=/usr/lib/llvm-${{ env.LLVM_VERSION }}/lib/cmake/mlir

      - name: Build hew-codegen
        run: cmake --build hew-codegen/build -j"$(nproc)"

      - name: Build standard library packages
        run: |
          cargo build --release \
            -p hew-std-encoding-base64 -p hew-std-encoding-compress \
            -p hew-std-encoding-csv -p hew-std-encoding-json \
            -p hew-std-encoding-markdown -p hew-std-encoding-msgpack \
            -p hew-std-encoding-protobuf -p hew-std-encoding-toml \
            -p hew-std-encoding-yaml \
            -p hew-std-crypto-crypto -p hew-std-crypto-jwt \
            -p hew-std-crypto-password \
            -p hew-std-net-http -p hew-std-net-ipnet -p hew-std-net-smtp \
            -p hew-std-net-url -p hew-std-net-websocket \
            -p hew-std-time-cron -p hew-std-time-datetime \
            -p hew-std-text-regex -p hew-std-text-semver \
            -p hew-std-misc-uuid -p hew-std-misc-log

      - name: Run Rust workspace tests
        run: cargo nextest run --workspace --exclude hew-wasm --profile ci

      - name: Run codegen unit tests
        run: >
          cd hew-codegen/build &&
          ctest --output-on-failure --output-junit codegen-unit.xml
          -R "^(mlir_dialect|translate)$"

      - name: Run codegen E2E tests (native)
        run: >
          cd hew-codegen/build &&
          ctest --output-on-failure --output-junit codegen-e2e-native.xml
          -j"$(nproc)" -LE wasm -E "^(mlir_dialect|translate)$"

      - name: Run codegen E2E tests (WASM)
        run: >
          cd hew-codegen/build &&
          ctest --output-on-failure --output-junit codegen-e2e-wasm.xml
          -j"$(nproc)" -L wasm

      - name: Upload test reports
        if: always()
        uses: mikepenz/action-junit-report@v5
        with:
          report_paths: |
            target/nextest/ci/junit.xml
            hew-codegen/build/codegen-unit.xml
            hew-codegen/build/codegen-e2e-native.xml
            hew-codegen/build/codegen-e2e-wasm.xml
          check_name: Test Results (Linux)

  # ─────────────────────────────────────────────────────────────────────────
  # Code coverage — Rust workspace tests instrumented with cargo-llvm-cov
  # ─────────────────────────────────────────────────────────────────────────
  coverage:
    name: Code coverage
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools

      - uses: taiki-e/install-action@cargo-llvm-cov
      - uses: taiki-e/install-action@nextest

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git/
            target/
          key: coverage-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: coverage-${{ runner.os }}-

      - name: Run tests with coverage
        run: >
          cargo llvm-cov nextest
          --workspace --exclude hew-wasm
          --lcov --output-path lcov.info

      - name: Generate HTML report
        run: >
          cargo llvm-cov report
          --html --output-dir coverage-html

      - name: Coverage summary
        run: cargo llvm-cov report | tee -a "$GITHUB_STEP_SUMMARY"

      - name: Upload coverage (lcov)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: lcov.info

      - name: Upload coverage (HTML)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: coverage-html/

  # ─────────────────────────────────────────────────────────────────────────
  # Build & test — Windows (LLVM provisioning deferred)
  # ─────────────────────────────────────────────────────────────────────────
  build-and-test-windows:
    name: Build & test (Windows)
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: windows-2022
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: choco install ninja cmake -y
        shell: pwsh

      # TODO: LLVM+MLIR provisioning (build from source, pre-built artifact, or installer)

      - uses: dtolnay/rust-toolchain@stable

      - uses: taiki-e/install-action@nextest

      - uses: actions/cache@v4
        with:
          path: |
            ~\.cargo\registry\
            ~\.cargo\git\
            target\
          key: build-test-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: build-test-${{ runner.os }}-

      - name: Build Rust crates
        run: cargo build -p hew-cli -p adze-cli -p hew-runtime -p hew-lsp --release

      - name: Run Rust workspace tests (no codegen)
        # hew-wasm requires wasmtime; hew-cabi has #[no_mangle] symbols
        # that conflict with hew-runtime when both are linked into a
        # test binary (duplicate symbol errors).
        run: >-
          cargo nextest run --workspace
          --exclude hew-wasm
          --exclude hew-cabi
          --profile ci

      - name: Upload test reports
        if: always()
        uses: mikepenz/action-junit-report@v5
        with:
          report_paths: target/nextest/ci/junit.xml
          check_name: Test Results (Windows)
