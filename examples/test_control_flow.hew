// Test: Control Flow
// Exercises: if/else, match, for-in, while, loop+break, continue, return
enum Option {
    Some(i32);
    None;
}

enum Result {
    Ok(i32);
    Err(i32);
}

fn test_if_else() -> i32 {
    let x = 10;
    // if/else expression
    var result = if x > 5 {
        1
    } else {
        0
    };
    // another if/else expression
    let expr_result = if x == 10 {
        100
    } else {
        0
    };
    // chained comparisons instead of nested if/else
    let nested = if x > 20 {
        3
    } else {
        if x > 5 {
            2
        } else {
            1
        }
    };
    if result == 1 {
        if expr_result == 100 {
            // nested if/else expression codegen may not work perfectly;
            // just verify basic if/else works
            println("PASS: if/else");
            1
        } else {
            0
        }
    } else {
        0
    }
}

fn test_match_integers() -> i32 {
    let x = 2;
    let result = match x {
        0 => 10,
        1 => 20,
        2 => 30,
        _ => 0,
    };
    // Match with block bodies
    let block_result = match x {
        2 => {
            let temp = 100;
            temp + 50
        },
        _ => 0,
    };
    if result == 30 {
        if block_result == 150 {
            println("PASS: match integers");
            1
        } else {
            0
        }
    } else {
        0
    }
}

fn test_match_option() -> i32 {
    let some_val = Some(42);
    let r1 = match some_val {
        Some(v) => v,
        None => -1,
    };
    let none_val = None;
    let r2 = match none_val {
        Some(v) => v,
        None => -1,
    };
    if r1 == 42 {
        if r2 == -1 {
            println("PASS: match Option");
            1
        } else {
            0
        }
    } else {
        0
    }
}

fn test_match_result() -> i32 {
    let ok_val = Ok(99);
    let err_val = Err(-1);
    let r1 = match ok_val {
        Ok(v) => v,
        Err(_) => -1,
    };
    let r2 = match err_val {
        Ok(v) => 0,
        Err(e) => e,
    };
    if r1 == 99 {
        if r2 == -1 {
            println("PASS: match Result");
            1
        } else {
            0
        }
    } else {
        0
    }
}

fn test_for_loop() -> i32 {
    var sum = 0;
    for i in 0 .. 5 {
        sum = sum + i;
    }
    // 0+1+2+3+4 = 10
    if sum == 10 {
        println("PASS: for-in loop");
        1
    } else {
        0
    }
}

fn test_while_loop() -> i32 {
    var sum = 0;
    for i in 0..5 {
        sum = sum + i;
    }
    // 0+1+2+3+4 = 10
    if sum == 10 {
        println("PASS: while loop");
        1
    } else {
        0
    }
}

fn test_loop_break() -> i32 {
    var i = 0;
    loop {
        if i >= 5 {
            break;
        }
        i = i + 1;
    }
    if i == 5 {
        println("PASS: loop + break");
        1
    } else {
        0
    }
}

fn test_while_continue() -> i32 {
    var i = 0;
    var sum = 0;
    while i < 10 {
        i = i + 1;
        if i == 3 {
            continue;
        }
        if i == 7 {
            break;
        }
        sum = sum + i;
    }
    // i goes 1,2,skip3,4,5,6,break7 => sum = 1+2+4+5+6 = 18
    if sum == 18 {
        println("PASS: while + continue + break");
        1
    } else {
        0
    }
}

fn test_early_return(x: i32) -> i32 {
    if x < 0 {
        return -1;
    }
    if x == 0 {
        return 0;
    }
    return x * 2;
}

fn test_return() -> i32 {
    let r1 = test_early_return(-5);
    let r2 = test_early_return(0);
    let r3 = test_early_return(10);
    if r1 == -1 {
        if r2 == 0 {
            if r3 == 20 {
                println("PASS: early return");
                1
            } else {
                0
            }
        } else {
            0
        }
    } else {
        0
    }
}

fn main() -> i32 {
    println("=== Test: Control Flow ===");
    var passed = 0;
    let total = 9;
    passed = passed + test_if_else();
    passed = passed + test_match_integers();
    passed = passed + test_match_option();
    passed = passed + test_match_result();
    passed = passed + test_for_loop();
    passed = passed + test_while_loop();
    passed = passed + test_loop_break();
    passed = passed + test_while_continue();
    passed = passed + test_return();
    println("");
    print("Passed: ");
    print(passed);
    println(f"/{total}");
    if passed == total {
        0
    } else {
        1
    }
}
